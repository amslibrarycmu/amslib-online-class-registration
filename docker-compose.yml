version: "3.8"

services:
  mysql:
    # Use the official MySQL image
    image: mysql:8.0
    container_name: amslib_mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD} # ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .env
      MYSQL_DATABASE: ${DB_DATABASE} # ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .env
      MYSQL_USER: ${DB_USER} # ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .env
      MYSQL_PASSWORD: ${DB_PASSWORD} # ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .env
    ports:
      - "3306:3306" # Map Port 3306 ‡∏Ç‡∏≠‡∏á Container ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Port 3306 ‡∏Ç‡∏≠‡∏á Host
    volumes:
      - mysql_data:/var/lib/mysql # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MySQL ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£
      - ./backend/schema:/docker-entrypoint-initdb.d # Mount ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå schema ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    healthcheck: # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ MySQL ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà Backend ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
      start_period: 10s # ‡πÄ‡∏û‡∏¥‡πà‡∏° start_period ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ MySQL ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci

  backend:
    build:
      context: . # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Context ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Build ‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
      dockerfile: Dockerfile # ‡πÉ‡∏ä‡πâ dockerfile ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ (‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å)
    container_name: amslib_backend
    ports:
      - "5000:5000" # Map Port 5000 ‡∏Ç‡∏≠‡∏á Container ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Port 5000 ‡∏Ç‡∏≠‡∏á Host
    environment:
      NODE_ENV: production
      DB_HOST: mysql # ‡∏ä‡∏∑‡πà‡∏≠ Service ‡∏Ç‡∏≠‡∏á MySQL Container
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      JWT_SECRET: ${JWT_SECRET}
      EMAIL_SERVICE: ${EMAIL_SERVICE}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS}
      EMAIL_AUTH_USER: ${EMAIL_AUTH_USER}
      EMAIL_AUTH_PASS: ${EMAIL_AUTH_PASS}
      MS_ENTRA_ID_CLIENT_ID: ${MS_ENTRA_ID_CLIENT_ID}
      MS_ENTRA_ID_CLIENT_SECRET: ${MS_ENTRA_ID_CLIENT_SECRET}
      MS_ENTRA_ID_TENANT_ID: ${MS_ENTRA_ID_TENANT_ID}
      MS_ENTRA_ID_REDIRECT_URI: ${MS_ENTRA_ID_REDIRECT_URI}
      FRONTEND_URL: http://localhost:5173 # ‡πÄ‡∏û‡∏¥‡πà‡∏° FRONTEND_URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Redirect ‡πÉ‡∏ô auth.js
    depends_on:
      mysql:
        condition: service_healthy # ‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ MySQL ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    volumes:
      - ./backend:/app/backend # Mount ‡πÇ‡∏Ñ‡πâ‡∏î Backend ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ (Live Reload)
      - /app/backend/node_modules # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á node_modules ‡∏à‡∏≤‡∏Å Host
      # üü¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Ñ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå uploads ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏≤‡∏ß‡∏£
      - ./backend/uploads:/app/backend/uploads
    command: npm start # ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á start ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô package.json ‡∏Ç‡∏≠‡∏á Backend

volumes:
  mysql_data: # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Named Volume ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MySQL
